Title: Процесс загрузки ПК, MBR x86 часть 1
Date: 10-21-2018 13:06
Category: PC
Tags: PC, MBR, boot process

![big open old hard drive]({static}/images/old-hard-drive.jpg)

# Введение 

В данной статье рассмотрим структуру MBR   

# MBR 

MBR (Master Boot Record) - специальная программа позволяющая ПК обнаружить активный раздел жесткого и диска и продолжить загрузку ОС. Концепция MBR была впервые представлена в 1983 г. с выходом MS-DOS 2.0. MBR располагается в первом (в LBA адресации это - сектор 0, в CHS адресации это - сектор 1, цилиндр 0, головка 0 – CHS (0,0,1)) секторе жесткого диска. MBR представляет собой 16-ти битный код загрузки (master boot code) и таблицу разделов жесткого диска. Код MBR выполняет следующие действия:
* Ищет в таблице разделов активный раздел; 
* Находит загрузочный сектор активного раздела (обычно это первый сектор активного раздела); 
* Загружает копию загрузочного сектора активного раздела в память; 
* Передает управление коду загрузочного сектора активного раздела. 

В случае неудачи MBR выводит сообщение об ошибке: 
* Invalid partition table;
* Error loading operating system;
* Missing operating system.

Т.к. MBR располагается в первом секторе загрузочного диска и соответственно отграничен размером сектора т.е. 512 байт. В столь малый объем умещается исполняемый код загрузчика, таблица разделов, 2 байта сигнатуры загрузки (Boot Signature) - 55AA. Таблица разделов имеет фиксированный размер и всегда занимает 64 байта, по 16 байт на каждый раздел. Таким образом MBR допускает наличие до 4-х основных (primary) разделов на диске, существуют способы создать на диске больше 4-х разделов, но описание подобных техник выходит за рамки данной статьи. На исполняемый код загрузчика остается 446 байт это весьма немного, но многие загрузчики занимают гораздо меньше. 

## Структура MBR 

| Поле |Размер |
--- | --- 
| Код загрузчика | 446 байт |
| Таблица разделов | 64 байт |
| Сигнатура загрузки | 2 байта |

Приведенное выше описание представляет собой некий шаблон, загрузчики различных ОС могут содержать различную дополнительную информацию жертвуя пространством доступным для кода загрузчика.

## Таблица разделов MBR.

Смещение (байт) | Размер | Назначение 
--- | --- | --- 
+0 | 1 | Статус диска, 80h -загрузочный, 00h -не загрузочный
+1 | 3 | CHS адрес первого сектора раздела, где:
 | | *1 байт - номер головки,
 | | *1 байт - биты 7-6 это старшие биты номера цилиндра, биты 0-5 это - номер сектора,
 | | *1 байт - младшие биты номера цилиндра.
+4 | 1 | Тип раздела 
+5 | 3 | CHS адрес последнего сектора раздела 
+8 | 4 | LBA адрес первого сектора раздела 
+12 | 4 | Кол-во секторов в разделе 

Т.к. адрес первого блока раздела (в адресации LBA) и кол-во секторов в разделе имеют разрядность 32 бита то отсюда следует что максимальный возможный размер раздела 2 Тб, при размере сектора в 512 байт.   

# VBR.

VBR – Volume Boot Record (загрузочная запись раздела) это первый сектор активного раздела жесткого диска. VBR содержит данные и код необходимые для дальней загрузки ОС. Как и MBR VBR занимает один сектор и имеет размер 512 байт и записывается на диск в процессе форматирования раздела.    

## Структура VBR 

MBR считывает в память VBR и передает ему управление, поэтому первые три байта это инструкция перехода исполняемую часть VBR. После инструкции перехода и до начала исполняемого кода находиться область данных, которую можно разделить на несколько секций: 

* OEM ID - строка символов, определяющая название и версию ОС, выполневший форматирование диска (MSWIN4.0 для Windows 95), размер поля в зависимости от файловой системы и ОС, для FAT16 – 8 байт;
* BPB (BIOS Parameter Block) - блок информации о разделе и файловой системе на нем, 25 байт;
* Extended BPB - расширенный BPB, 26 байт;
* Bootstrap Code - исполняемый код загрузчика, 448 байт;
* 55hAAh - марке конца сектора, 2 байта.

BPB и Extended BPB содержат информацию о файловой системе, в которую был отформатирован раздел. Исполняемый код загрузчика использует данные из BPB чтобы обнаружить начало корневого раздела ФС (Root directory), выполнить поиск ядра ОС и загрузить его в память. Рассмотрим структуры BPB и Extended BPB, в качестве примера возьме FAT16: 

## Структура BPB 

Смещение | Размер | Описание 
--- | --- | ---
0x0B | WORD | Bytes Per Sector - размер сектора в байтах, обычно 512
0x0D | BYTE | Sectors Per Cluster - кол-во секторов на кластер, FAT16 выделяет для хранения файла целое код-во кластеров, минимум один 
0x0E | WORD | Reserved Sectors - кол-во секторов до начала файловой системы включая Boot Sector 
0x10 | BYTE | Number of FATs – FAT обычно содержит две таблицы размещения файлов, поле указывает кол-во таких таблиц  
0x11 | WORD | Root Entries - кол-во 32-х байтных записей о файлах или директориях в корневом каталоге 
0x13 | WORD | Small Sectors - кол-во секторов в разделе, для больших дисков равно 0 
0x15 | BYTE | Media Descriptor - тип носителя (жесткий диск или дискета) 
0x16 | WORD | Sectors Per FAT – кол-во секторов, занимаемых каждой FAT таблицей 
0x18 | WORD | Sectors Per Track - кол-во секторов на дорожку, актуально для дискет 
0x1A | WORD | Number of Heads - кол-во головок 
0x1C | DWORD | Hidden Sectors - кол-во скрытых секторов на разделе до загрузочного сектора 
0x20 | DWORD | Large Sectors - кол-во секторов на раздел 

## Структура Extended BPB: 

Структура Extended BPB 

Смещение | Размер | Описание 
--- | --- | ---
0x24 | BYTE | Physical Drive Number - номер диска, согласно BIOS 
0x25 | BYTE | Reserved - зарезервировано, для FAT16 равно нулю 
0x26 | BYTE | Extended Boot Signature - сигнатура, обычно равна 0x28 или 0x29 
0x27 | DWORD | Volume Serial Number - случайный серийный номер 
0x2B | 11 байт | Volume Label - метка тома, устарело метка тома хранится в файле в Root directory 
0x36 | LONGLONG | File System Type – тип файловой системы 

В некоторых случаях (для простых файловых систем и для простых ОС) 512 байт может быть вполне достаточно для размещения кода загрузчика способного выполнить поиск ядра ОС и загрузить его в память. В таких случаях Reserved Sectors равно единице. Если 512 байт недостаточно то резервируются дополнительные сектора и в них размещается дополнительный код загрузчика а значение поля  Reserved Sectors соответственно увеличивается.

# Ограничения MBR и VBR.

Схема загрузки ПК с применением MBR и VBR была придумана очень давно, когда жесткие диски были маленькие, а операционные системы простыми. Подобная схема вполне подходит для для загрузки 16-битной ОС с дискеты или диска с разделами, отформатированными в простую файловую систему вроде FAT12 или FAT16.  Современные процессоры стали сложнее и требуют дополнительных действий (переход в защищенный режим) для того, чтобы задействовать все их возможности, ОС тоже стали сложнее и надежнее, размер ядер вырос и 512 байт VBR стало недостаточно для загрузки ядра в память. Для решения этой проблемы VBR увеличили и возложили на него дополнительные функции. Но одна проблема все-же осталась: все эта схема загрузки сильно привязана к версии и к разработчику ОС. Установить на компьютер две ОС и легко переключаться между ними через перезагрузку было невозможно! Для решения этой проблемы была придумана спецификация multiboot и разработан наиболее гибкий загрузчик - GRUB. Так же MBR накладывает ограничение на максимальный размер раздела в 2 Тб.

Накладываемые ограничения вряд ли смутят большинство домашних пользователей.

# Источники.

* http://thestarman.pcministry.com/asm/mbr/index.html#MBR
* https://technet.microsoft.com/en-us/library/cc976786.aspx
* https://technet.microsoft.com/en-us/library/cc976796.aspx
* http://www.brokenthorn.com/Resources/OSDev5.html
* http://thestarman.pcministry.com/asm/mbr/index.html#BR