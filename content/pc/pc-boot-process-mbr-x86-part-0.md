Title: Процесс загрузки ПК, MBR x86 часть 0
Date: 11-02-2019 13:06
Category: PC
Tags: PC, MBR, boot process

# Введение 

Я считал и продолжаю считать что понимание процесса загрузки ПК и процесса запуска операционной системы очень важно для любого уважающего себя ИТ специалиста. Понимание процессов протекающих во время запуска ПК часто может помочь продиагностировать как аппаратные так и программные сбои, кроме того эти знания позволяют сохранить время и выполнить восстановление ОС к работоспособному состоянию без переустановки. К сожалению в профильной литературе процессу загрузки несправедливо удиляется мало внимания и подробности приходится искать в различных статьях в интернете и журналах. Я хочу исправить эту несправедливость и описать процесс старта ПК максимально подробно и информативно.   
В рамках цикла статей я хочу рассмотрю процесс загрузки ПК как в общих чертах так и на конкретных примерах:
* MS DOS/FreeDOS,
* Windows 9x,
* Windows NT,
* Windows 7,
* Linux (GRUB),
* FreeBSD.

# Процесс загрузки ПК

Процесс загрузки ПК начинается с нажатия кнопки и подачи питания на материнскую плату. Первым делом, после включения питания, ЦП находит код BIOS и начинает его исполнять но ОЗУ энергозависима и сразу после включения она совершенно пустая - там нет никаких инструкций и процессору ничего исполнять! Код BIOS храниться в специальной микросхеме, распаянной на материнской плате. Давным-давно производители договорились что BIOS будет располагаться по заранее известному адресу - 000F:FFF0h, и ЦПУ начинает свою работу с того, что копирует код BIOS в ОЗУ. Вот в этой процедуре (и общем понимании архитектуры ЭВМ) кроется ответ на вопрос почему ПК без памяти не загрузится, даже в BIOS.

После того как BIOS будет успешно скопирован в ОЗУ, процессор переходит к выполнению инсрукций. Сначала проводится инициализация и проверка оборудования - этот процесс носит название POST (Power On-Self Test). В процессе прохождения POST ЦПУ определяет и инициализирует видеокарту в случае успеха на экране отображается модель видеокарты и указывается объем доступной ей памяти. Далее идет проверка ОЗУ, обычно проверяется только первый мегабайт, но часто производители BIOS оставляют возможность включить полную проверку. Полная проверка ОЗУ сильно увеличивает время загрузки ПК. Затем следует процесс обнаружения и инициализации ЖД - в этот момент на экране отображается список доступных устройств хранения данных.

Один из дисков в настройках  BIOS'а помечен как загрузочный. С загрузочного диска BIOS считывает MBR в память компьютера и переходит к выполнению кода MBR. В MBR хранится таблица разделов и код для дальнейшей загрузки ОС. Формат таблицы разделов стандартизован, а вот способов дальнейшей загрузки ОС великое множество.

# Проблемы MBR

Для дальнейшей загрузки ОС нужно выполнить несколько действий:
1. перевод процессора в защищенный режим,
2. поиск ядра на ЖД,
3. чтение и загрука ядра в ОЗУ,
4. передача управления ядру.
Причем перевод процессора в защищенный режим выполняется не во всех вариантах. Размер MBR ограничен размером сектора ЖД - 512 байт этого совершенно недостаточно для выпонения указанных задач. Разные загрузки решают эту проблему по разному, рассмотрим варианты.

1. Записать в MBR адреса секторов в которых храниться ядро. В таком случая MBR нет нужды понимать ФС и достаточно загрузить содержимое нескольких секторов в память и передать управление. Для того чтобы это было возможно ядро ОС должно быть либо очень компактным (Kolibri OS?) и/или должно быть поделено на две части - одна должна работать в реальном режиме а вторая часть уже в защищенном. Первая часть ядра переводит процессор в защищенный режим, считывает в память вторую часть и передает ей управление. Вторая часть уже в защищенном режиме запускает драйвера, запускает сервисы и выполняет задачи по управлению ресурсами ПК. В некоторых случаях первая часть ядра может храниться в свободном пространстве между первым сктором ЖД и первым сектором первого раздела. Это пространство обвчно нечем не занято и существует по соображениям обратной совместимости (давным-давно разделы должны были быть выровнены по цилиндрам для лучшей производительности). Доступный объем состовляет 62 сектора или примерно 32 Кб.
1.1. При использовании файловых систем семейства FAT (FAT16, FAT32) 512 байт может оказаться вполне достаточно чтобы выполнить поиск и загрузку ядра ОС. 
2. Многоступенчатый (многостадийный) загрузкик. Загрузчик ОС состоит из несколький частей, MBR является первой частью или первичным загрузчиком. В таком случае MBR выполняет загрузку второй ступени (вторичный загрузчик) которая в свою очередь выполняет поиск и загрузку ядра ОС. Вторичный загрузчик обыно разпологается в свободном пространстве между первым сектором ЖД и первым сектором первого раздела, но в некоторых случаях вторичный загрузчик помещают в первый сектор первого раздела. Бавает что процесс загрузки состоит из более чем двух частей, в этом случает вторичный загрузчик загружает не ядро а следующую стадию загрузчика (grub legacy, FreeBSD).

# Заключение

Загрузка ОС довольно сложный процесс и разработчики различных ОС подходят к решинию возникающих проблем по разному. Хоть детали и отличаются но понимание основ позволит быстро заробраться в том как работает конкретная реализация и возможно когда-нибудь спасти поврежденную систему и/или не наделать глупостей при миграции на другой диск или при изменении таблицы разделов. 
