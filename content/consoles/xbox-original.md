Title: Original Xbox
Date: 10-10-2019 13:06
Category: Консоли
Tags: Microsoft, Xbox, consoles

# Введение

![Xbox original itself]({static}/images/1280px-Xbox-console.jpg)

X-Box original является, возможно, самой интересной и необычной консолью в своем поколении. А необычность X-Box’а заключается в его обычности! Под капотом X-Box почти обычный ПК! Добавляет сходства и наличие жесткого диска (ни PS 2, ни GameCube не имели жесткого диска), а в качестве привода служит обычный IDE DVD-ROM.   

# Технические характеристики

![Xbox original motherboard]({static}/images/xbox-original-motherboard.png)

CPU: Intel Pentium III "Copermine-based" @ 733 MHz (обведен синим)
RAM: 64 MiB DDR SDRAM @ 200 MHz (объведены зеленым)
Storage: DVD-ROM Drive (above, left), 8 or 10 GB HDD (above, right)
Graphics: 233 MHz nVidia NV2A Graphics Controller (по центру)
Networking: 100 MBit Ethernet

С целью сократить срок разоаботки новой консоли и уменьшить конечную стоимость инженеры Microsoft приняли решение использовать компоненты обычного ПК для аппаратной начинки консоли. X-Box original поставлялся с установленным IDE HDD объемом 10 Гб, на который нельзя было устанавливать игры, диск используется как хранилище сохранений, кэширования различный данных игр, а также содержит системное ПО - dasboard и музыкальный проигрыватель. Порты для подключения геймпадов на самом деле являются USB 1.1.

# Процесс загрузки

Как и обычные x86 ПК того времени материнская плата XBox содержала микросхемы северного и южного моста со схожим функционалом. Микросхема южного моста в дополнении к своим основным функциям (звуковой процессор, поддержка USB, PCI, IDE) содержит небольшую (512 байт) область ROM памяти. С инструкций, хранящихся в этой области, начинается загрузка XBox. MCPX ROM - первичный загрузчик XBox.

## Энергонезависимая память

* MCPX ROM - небольшая (512 байт) область памяти расположенная в микросхеме южного моста, содержит код первичного загрузчика;
* FLASH ROM - микросхема Flash памяти емкостью 1 Мб, содержит Вторичный загразчик (2bl), сжатое и шифрованное ядро XboxOS и область с X-code инструкции интерпретируемые первичным загрузчиком, используются для инициализации оборудовани;

## Загрузка Xbox

![Xbox original dashboard]({static}/images/xbox-original-dashboard.jpg)

1. Первичный загрузчик - выполняет начальную инициализацию системы интерпритируя и исполняя иструкции из области с X-code, расшифровывает и передает управление Вторичному загрузчику;
2. Вторичный загрузчик - расшифровывает, загружает в RAM и передает управление ядру XBoxOS;
3. Ядро XBoxOS - отвечает за управление ресурсами и предоставляет HAL (Hardware Abstraction Layer) для запускаемого ПО (Dasboard или игры);
4. Если в лотке DVD-ROM присутчтвуе диск ядро загрузит програму с DVD-диска, если нет выполнит запуск Dasboard с ЖД.  

Если по аппаратному обеспечению X-Box сильно похож на домашний ПК своего времени то процесс загрузки - то место где X-Box очень сильно отличается от ПК. Процесс загрузки X-Box состоит из нескольких стадий:
* Загрузчик из Secret ROM, выполняет инициализацию оборудования, проверяет целостность FLASH RAM, извлекает из FLASH RAM вторичный загрузчик и передает ему управление;
* Вторичный загрузчик выполняет расшифровку ядра, копирует код ядра в память и передает управление ядру;
* Ядро XboxOS проверяет наличие диска с игрой в приводе, если диск найден то запускает игру, если нет то запускает dasboard с ЖД.  
Таким образом на довольно раннем этапе мы получаем загруженное в память ядро XBoxOS. Ядро исполняет только подписанный код. Эта особенность работы X-Box препятствовала возможности запуска других ОС, ведь ключа для подписи исполняемых файлов у Linux-энтузиастов не было.

# XboxOS

Сначала Microsoft хотела использовать Windows как операционную систему для X-Box но очень быстро стало понятно что Windows не подходит для того чтобы обеспечить максимально быстрый старт и запуск игр. Нужно было разрабатывать отдельное решение. Таким решением стало сильно модифицированное и урезанное ядро Windows 2000. Ядро XboxOS занимает в сжатом виде ~256 Кб, в несжатом ~500 Кб. Так, например, XboxOS не поддерживает динамическую линковку, отсутствуют различные уровни привилегий, остался только уровень ядра. Все это было сделано для того чтобы предоставить играм доступ к оборудованию и снизить накладные расходы. На диске располагаются dasboard, проигрыватель, шрифты и другое прикладное ПО. Судя по всему прикладное ПО и явилось причиной добавления ЖД в конфигурацию X-Box, дело в том что dasboard довольно крупное ПО и занимает около 100 Мб дискового пространства. В качестве файловой системы используется FATX основанная на FAT32. Хотя FATX и FAT32 принадлежат к одному семейству ФС они не совместимы и компьютеры того времени, работающие под управлением различных версий Windows файловую систему X-Box’а не понимали, а энтузиасты и хакеры использовали для доступа к ФС Linux для которого необходимый драйвер вскоре появился. На ЖД нет библиотек DirectX и каких либо других вспомогательных библиотек, игры статически линковались со всеми необходимыми им библиотеками. Разделы на жестком диске:
* С: - системный раздел, содержит dashboard
* D: - DVD-ROM
* E: - системный раздел, на нем хранятся сохранения игр, музыка закаченная на X-Box
* F, G - не родные разделы, обычно создаются при замене ЖД на более емкий
* X: Y: Z: - Это разделы кеша, там хранятся временные файлы от игры, в которая в данным момент запущена. Без них Xbox работать не будет.

# Homebrew

Силами энтузиастов методом обратной разработки был создан OpenXDK - свободный SDK для разработки программ для X-Box. Для X-Box было разработано несколько альтернативных dashboard’ов которые предоставляли намного более обширный функционал чем оригинальная оболочка от Microsoft, так, например, используя альтернативную оболочку можно было устанавливать игры с дисков на HDD и другое ПО, такое как эмуляторы, получать доступ к содержимому диска по протоколу FTP и многое другое. Также альтернативные оболочки предоставляли больше информации о системе, позволяли менять регион консоли и др. Для X-Box был разработан весьма неплохой медиацентр - XBMC, портированы некоторые игры, например, DOOM.  

# Запуск Linux

Из-за особенностей процесса загрузки X-Box у Linux энтузиастов было два способа запустить Linux:
1. Перезаписать или обойти FLASH-память так чтобы первичный загрузчик никогда не загружал вточный загрузчик (2bl) и ядро XboxOS. Недостатком является невозможность дальнейшего использования X-Box original в качестве игровой приставки, что на мой взгляд делает этот прием менее полезным с практической точки зрения. Для реализации этого метода была разработана специальная версия прошивки для X-Box, которая позволяла выполнить загрузку Linux с HDD, называется прошивка Cromwell;
2. Использовать специальный modchip, который содержит несколько версий BIOS и позволяет переключаться между ними;
3. Заставить ядро XboxOS выполнять неподписанный код, написать спицеальную программы которая будет производить запуск Linux уже из-под запущенной XboxOS. Для реализации используя softmod. Установка дистрибутива Linux производится в существующий раздел HDD (обычно F:). Для реализации используется специальная версия Cromwell в виде исполняемого файла XBE и называется xromwell. Такой способ оставляет возможность запуска оригинальной XboxOS и я считаю что это наиболее интересный с технической точки зрения метод.

# Источники

* http://hackspot.net/XboxBlog/
* https://mborgerson.com/deconstructing-the-xbox-boot-rom/
* https://events.ccc.de/congress/2005/fahrplan/attachments/591-paper_xbox.pdf 